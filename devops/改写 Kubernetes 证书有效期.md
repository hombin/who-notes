# 改写 Kubernetes 证书有效期

Author: Hombin



#### 背景

1. 基于 k8s 安全理念，k8s 的证书需要 1 年更新一次保证升级频率
2. 客户生产环境 不适用每年定期升级的场景，需要重写证书更新逻辑
3. 以下编译 Kubeadm 替换方式 已验证适用 k8s 版本 : v1.17 — v1.23



#### 步骤

1. 检查证书 有效期

    ```shell
    # v1.20 及以后版本
    kubeadm certs check-expiration
    # v1.19 及之前版本（alpha 命令 1.21 开始彻底废弃）
    kubeadm alpha certs check-expiration
    ```

    

2. 获取源码

    ```shell
    # 创建存放目录
    mkdir -p /data4/k8s-src && cd /data4/k8s-src
    
    # 查看 k8s 版本，下载对应版本源码
    kubeadm version
    wget https://github.com/kubernetes/kubernetes/archive/v1.20.4.tar.gz
    # 解压
    tar -zxvf kubernetes-1.20.4.tar.gz
    ```

    ```shell
    # 或者 git 方式拉取（与下载源码方式 2选1即可）
    yum install git
    git clone https://github.com/kubernetes/kubernetes.git
    cd kubernetes
    git checkout -b remotes/origin/release-1.23 v1.23.4
    ```

    

3. 修改证书有效期相关代码

    ```shell
    # 进入源码 根目录
    cd kubernetes-1.20.4
    
    # 修改 CA 有效期至 100年（默认是 10年）
    vim ./staging/src/k8s.io/client-go/util/cert/cert.go
    ```

    ```go
    // NewSelfSignedCACert 方法里面 NotAfter: now.Add(duration365d * 10).UTC()
    // 默认有效期就是 10 年，改成 100 年
    // 输入 /NotAfter 查找，回车定位
    func NewSelfSignedCACert(cfg Config, key crypto.Signer) (*x509.Certificate, error) {
            now := time.Now()
            tmpl := x509.Certificate{
                    SerialNumber: new(big.Int).SetInt64(0),
                    Subject: pkix.Name{
                            CommonName:   cfg.CommonName,
                            Organization: cfg.Organization,
                    },
                    NotBefore:             now.UTC(),
                    // NotAfter:              now.Add(duration365d * 10).UTC(),
                    NotAfter:              now.Add(duration365d * 100).UTC(),
                    KeyUsage:              x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign,
                    BasicConstraintsValid: true,
                    IsCA:                  true,
            }
    
            certDERBytes, err := x509.CreateCertificate(cryptorand.Reader, &tmpl, &tmpl, key.Public(), key)
            if err != nil {
                    return nil, err
            }
            return x509.ParseCertificate(certDERBytes)
    }
    ```

    ```shell
    # 修改 证书有效期至 100年（默认为 1年）
    vim ./cmd/kubeadm/app/constants/constants.go
    ```

    ```go
    // 修改 常量定义 CertificateValidity，改成 * 100 年
    // 输入 /CertificateValidity 查找，回车定位
    const (
            // KubernetesDir is the directory Kubernetes owns for storing various configuration files
            KubernetesDir = "/etc/kubernetes"
            // ManifestsSubDirName defines directory name to store manifests
            ManifestsSubDirName = "manifests"
            // TempDirForKubeadm defines temporary directory for kubeadm
            // should be joined with KubernetesDir.
            TempDirForKubeadm = "tmp"
    
            // CertificateValidity defines the validity for all the signed certificates generated by kubeadm
            // CertificateValidity = time.Hour * 24 * 365
            CertificateValidity = time.Hour * 24 * 365 * 100
    
            // CACertAndKeyBaseName defines certificate authority base name
            CACertAndKeyBaseName = "ca"
            // CACertName defines certificate name
            CACertName = "ca.crt"
            // CAKeyName defines certificate name
            CAKeyName = "ca.key"
    ```

    ```shell
    # 如果是 git 拉取的代码可以使用 git diff 检查一下改动
    git diff
    
    # 查看 kube-cross 的 TAG 版本号，后面编译参考对应 Go环境版本
    cat ./build/build-image/cross/VERSION
    ```

    

4. 编译环境准备

    ```shell
    # 安装编译工具（CentOS）
    yum install gcc make -y
    yum install rsync jq -y
    
    # 安装编译工具（Ubuntu）
    sudo apt install build-essential #(Following command will install essential commands like gcc, make etc.)
    sudo apt install rsync jq -y
    
    # 下载 Golang 包（参考源码查看的 Go版本）
    wget https://dl.google.com/go/go1.15.8.linux-amd64.tar.gz
    # 或者
    wget https://golang.google.cn/dl/go1.15.8.linux-amd64.tar.gz
    # 解压
    tar zxvf go1.15.8.linux-amd64.tar.gz  -C /usr/local
    
    # 添加环境变量
    vim /etc/profile.d/golang.sh
    ```

    ```shell
    # golang setting
    export GOROOT=/usr/local/go
    export GOPATH=/usr/local/gopath
    export PATH=$PATH:$GOROOT/bin
    ```

    ```shell
    # .sh 配置生效
    source /etc/profile
    
    # 一次性编译（不需要添加 .sh配置）
    export PATH=$PATH:/usr/local/go/bin
    
    # 检查 Go环境变量
    go version
    ```

    

5. 编译

    ```shell
    # 在 源码根目录 编译 kubeadm, 这里主要编译 kubeadm 即可
    make all WHAT=cmd/kubeadm GOFLAGS=-v
    
    # 编译 kubelet 命令
    # make all WHAT=cmd/kubelet GOFLAGS=-v
    
    # 编译 kubectl 命令
    # make all WHAT=cmd/kubectl GOFLAGS=-v
    
    # 编译结果存放在 _output/bin/kubeadm 目录下
    # 其中 /bin 是使用的 软连接
    # 真实路径是 _output/local/bin/linux/amd64/kubeadm
    
    # 备份当前 kubeadm
    mv /usr/bin/kubeadm /usr/bin/kubeadm_`date +%F`
    # 复制 & 替换 & 赋权
    cp _output/local/bin/linux/amd64/kubeadm /usr/bin/kubeadm
    chmod +x /usr/bin/kubeadm
    ```

    ```shell
    # 确认 kubeadm BuildDate 等信息
    kubeadm version
    
    # 压缩更新后的 kubeadm 到用户主目录下（root用户保存在 /root 目录下）
    tar zcvf ~/kubeadm-1.20.4.tgz -C /usr/bin/ kubeadm
    
    # 上传其他节点 并 替换原有版本 kubeadm
    mv /usr/bin/kubeadm /usr/bin/kubeadm_`date +%F`
    tar zxvf ./kubeadm-1.20.4.tgz -C /usr/bin/
    ```

    

6. 更新证书

    ```shell
    # 各节点 备份旧的证书及配置（证书在./pki 目录下）
    cp -arp /etc/kubernetes /etc/kubernetes.bak_`date +%F`
    
    # 备份 etcd 数据目录（主节点）
    cp -r /var/lib/etcd /var/lib/etcd.bak_`date +%F`
    ```

    ```shell
    # CA 证书的时间更新需要 init 初始化操作，生成 config 文件后生效
    #（非新集群搭建，不建议做此部分操作）
    #cd /etc/kubernetes/
    #kubectl get cm -o yaml -n kube-system kubeadm-config > kubeadm.yaml
    # 此步骤需要根据集群配置调整参数，建议参考 官网文档 再操作
    #kubeadm init phase kubeconfig all --config kubeadm.yaml
    
    # 更新 config 文件
    #mv $HOME/.kube/config $HOME/.kube/config.bak_`date +%F`
    #cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    #chown $(id -u):$(id -g) $HOME/.kube/config
    ```

    ```shell
    # 续订全部证书
    kubeadm certs renew all
    
    # 检查 重新编译的 kubeadm 到期时间是否正确
    kubeadm certs check-expiration
    # 早期版本 (1.19 及之前版本) 命令如下
    # kubeadm alpha certs check-expiration
    
    # 根据 k8s 提示，手动重启 各个主节点 相关主服务
    # Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.
    docker restart `docker ps | grep etcd  | awk '{ print $1 }'`
    docker restart `docker ps | grep kube-apiserver  | awk '{ print $1 }'`
    docker restart `docker ps | grep kube-scheduler  | awk '{ print $1 }'`
    docker restart `docker ps | grep kube-controller-manager  | awk '{ print $1 }'`
    # 或者 一行命令 全部重启
    docker ps | grep -v pause | grep -E "etcd|scheduler|controller|apiserver" | awk '{print $1}' | awk '{print "docker","restart",$1}' | bash
    ```

    

7. 检查更新结果

    ```shell
    # 检查 到期时间
    kubeadm certs check-expiration
    # 确认 到期时间
    echo | openssl s_client -showcerts -connect 127.0.0.1:6443 -servername api 2>/dev/null | openssl x509 -noout -enddate
    # 查看所有证书到期时间
    for i in $(ls /etc/kubernetes/pki/*.crt);do echo $i;openssl x509 -in $i -noout -text | grep ' Not ';done
    ```

    



#### 备注

1. 如果是 新安装的 k8s 集群也可以 按照此文档更新有效期，在部署前编译替换 kubeadm 即可；
2. 证书更新 均为覆盖命令，切记要做好备份再执行命令。




